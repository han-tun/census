<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'/>
<title>Census</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans|Merriweather+Sans:400,700' rel='stylesheet' type='text/css'>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.css' rel='stylesheet' />
<style>

body {
    margin:0;
    padding:0;
    background:#fff;
    -webkit-text-size-adjust: 100%;
}

.mapholder {
    display:block;
}

#map {
    width: 100%;
    height: 650px;
}

canvas:focus {
    border:none !important;
    outline:0;
    -webkit-box-shadow: none;
    box-shadow: none;
}

.mapboxgl-ctrl.mapboxgl-ctrl-attrib {
    background-color: rgba(255,255,255,0); 
    color:#555;
    }

.mapboxgl-ctrl-attrib a {
    color: #555;
}

.mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px Open Sans, Arial, Helvetica, sans-serif;
}

.mapboxgl-popup h3{
    margin-top: 0px;
  margin-bottom: 2px;
}

#popup {
    color:#555;
}

#mainpoint {
    font-size:30px;
    font-weight: bold;
    text-align: center;
    margin:5px;
    margin-bottom: 10px;
}

#place {
    font-size:10px;
    color:#999;
    line-height: 12px;
}

#header {
    font-family:Open Sans, Arial, Helvetica, sans-serif;
    font-size:12px;
    color:#555;
    background:rgba(255,255,255,0);
    padding:10px;
    margin:auto;
    display:block;
    max-width:1000px;
    text-align: center;
}

/*#header div {
    display:inline-block;
    vertical-align: middle;
}*/

#headtext {
    font-size: 20px;
    line-height: 23px;
    margin-bottom: 10px;
}

#desc {
    max-width: 404px;
    display: block;
    margin: auto;
}

/*NOTES*/

.mapnotes {
  display: block;
  margin:0 auto;
  text-align: center;
  margin-right: 10px;
  padding-bottom: 10px;
  color:#555;
}

.mapnotes p {
  font-family:Open Sans, Arial, Helvetica, sans-serif;
  font-size:11px;
  margin-bottom: -9px;
}

.mapnotes a {
    text-decoration: none;
    color:#555;
}

/*BUTTONS*/

.prtoggles {
    text-align: center;
    padding:10px;
    margin:auto;
    display:block;
}

.prtoggles div {
    font-family:Open Sans, Arial, Helvetica, sans-serif;
    font-size: 10px;
    font-weight: bold;
    color:#555;
    display: inline-block;
    width: 100px;
    padding: 7px;
    margin-bottom: 3px;
    line-height:12px;
    border-radius: 2px;
    border: 1px solid #d3d3d3;
    background:#fff;
    text-align: center;
    box-shadow: 0 2px 4px rgba(255,255,255,0.1);
}

.prtoggles div:hover {
    opacity:1;
    background:#efefef;
    cursor: pointer;
}

.prtoggles div.active {
    opacity:1;
    background:#fff;
    cursor: pointer;
    border:1px solid #555;
    pointer-events:none;
}

/*CIRCLEGEND*/

#circlegend {
    font-family:Open Sans, Arial, Helvetica, sans-serif;
    display: inline-block;
    margin: auto;
    width:125px;
    padding: 0px;
    margin-right: 20px;
      }

#circlegend label, #circlegendtwo label {
    display:inline-block;
    height:15px;
    text-align:center;
    font-size:9px;
    color:#808080;
      }

#circlegend span {
    opacity:0.8;
    display:block;
    float:left;
    border:1px solid #d3d3d3;
    height:15px;
    width:19px;
    border-radius:30px;
      }

#circlegendtwo {
    font-family:Open Sans, Arial, Helvetica, sans-serif;
    display: inline-block;
    margin: auto;
    width:125px;
    padding: 0px;
      }

#circlegendtwo span {
    opacity:0.8;
    display:inline-block;
    height:5px;
    width:20px;
    background:#fb6a4a;
    margin-left: -3px;
      }

/*CHART*/

.chartholder {
  font-family: Open Sans, Arial, Helvetica, sans-serif;
  font-size:10px;
  width: 100%;
  max-width: 415px;
  display: block;
  margin:auto;
  margin-bottom: 10px;
  text-align: center;
}

.chartholder div {
    display:inline-block;
    text-align: center;
    width:24%;
}

.years {
    font-family: Open Sans, Arial, Helvetica, sans-serif;
    border:0px;
    color:#999;
    margin-bottom: 3px;
}

.numbers {
  font-size:12px;
  font-weight:bold;
  color:#999;
  border-right:1px dashed #888888;
}

@media (max-width:550px) {
    #map {
        height:300px;
    }
    #circlegendtwo {
        width: 107px;
    }
    .prtoggles div {
        width: 130px;
        padding: 10px;
    }
}

</style>
</head>
<body>
<div id="header">
    <div id="headtext">Testing... A look at Canada's changing population</div>
    <div id="desc">
            Percentage change in population (2011-2016)
    </div>
    <div id='circlegend'>
            <nav class='circlegend clearfix'>
              <label id="onelabel" style="margin-right: 7px;">small pop.</label>
              <label id="twolabel" style="margin-right:18px">large pop.</label>
              <span style='width:12px;height:12px;margin-left: 7px;margin-top: 8px;'></span>
              <span style='width:14px;height:14px;margin-top: 6px;'></span>
              <span style='width:16px;height:16px;margin-top: 4px;'></span>
              <span style='width:18px;height:18px;margin-top: 2px;'></span>
              <span style='height:20px;'></span>
            </nav>
        </div>
    <div class="toggleholder">
        <div class="prtoggles">
            <div id="prbtn" data-id="all" class="active">ALL</div>
            <div id="prbtn" data-id="Ontario" style="color:#756BB1">ONTARIO</div>
            <div id="prbtn" data-id="British Columbia" style="color:#31A354">BRITISH COLUMBIA</div>
            <div id="prbtn" data-id="Quebec" style="color:#17BECF">QUEBEC</div>
            <div id="prbtn" data-id="Alberta" style="color:#FF3030">ALBERTA</div>
            <div id="prbtn" data-id="Prairies" style="color:#FDAE6B">PRAIRIES</div>
            <div id="prbtn" data-id="Maritimes" style="color:#3182BD">MARITIMES</div>
            <div id="prbtn" data-id="Territories" style="color:#E377C2">TERRITORIES</div>
        </div>
    </div>
</div>
<div class="mapholder">
    <div id='map'></div>
</div>
<div class="mapnotes">
  <p><strong>Note:</strong> One area closest to the net was excluded from the 'per cent made' calculation because of the large difference in total shots taken compared with the rest of the court. All player shots are during their time as a Toronto Raptor. Lowry and DeRozan shots are as of 15'-16' season.</p>
  <p><strong>Source:</strong> NBA, ColorBrewer, Mapbox, basketball-reference</p>
  <p><strong>By:</strong> <a href="http://www.mapto.ca/" target="blank">Bettermaps</a></p>
  <p>Code on <a href="https://github.com/willymaps/cartershots" target="blank">GitHub</a></p>
</div>

<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoid2lsbGlhbWJlbmRhdmlzIiwiYSI6IlVrb3BGVzQifQ.jeHxDCnpXXvAXKfAFEYG-A';

var bounds = [
    [0.0,-2.1],
    [6.2,2.0]  // Northeast coordinates
];

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/empty-v8',
    center: [0, 0],
    minZoom:4,
    maxZoom:9
});

map.scrollZoom.disable();

map.on('load', function() {

    map.fitBounds(bounds, {
            padding: 30
        });

    // ADD GRID
    map.addSource("gridData", {
        'type': 'geojson',
        'data': 'grid.geojson'
    });

    map.addLayer({
        "id": "gridlines",
        "type": "line",
        "source": "gridData",
        "layout": {
            "line-join": "round",
            "line-cap": "round"
        },
        "paint": {
            "line-width": 0.5,
            "line-blur": 1,
            "line-color": "#555"
        }
    });

    // ADD GRID LABELS
    map.addSource("gridLabels", {
        'type': 'geojson',
        'data': 'grid_labels.geojson'
    });

    map.addLayer({
        "id": "gridlabels",
        "type": "symbol",
        "source": "gridLabels",
        "layout": {
            "text-field": "{name}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-size": 10,
            "text-offset": [-0.3, 0 ],
            "text-anchor": "right"
        },
        "paint": {
            "text-color": "#555"
        }
    });

    // ADD LINES
    map.addSource("lineData", {
        'type': 'geojson',
        'data': 'lines.geojson'
    });

    map.addLayer({
        "id": "poplines3D",
        "type": "fill-extrusion",
        "source": "lineData",
        'layout': {
            visibility: 'none'
        },
        "paint": styleLine3D()
    });

    map.addLayer({
        "id": "poplines",
        "type": "line",
        "source": "lineData",
        "layout": {
            "line-join": "round",
            "line-cap": "round"
        },
        "paint": styleLine() 
    });

    // ADD POINTS
    map.addSource("popData", {
        'type': 'geojson',
        'data': 'popchange.geojson'
    });

    map.addLayer({
        "id": "poppoints",
        "type": "circle",
        "source": "popData",
        "layout": {},
        "paint": stylePop()
        // "paint": stylePop()
    });

    // STYLE POINTLABELS
    map.addLayer({
        "id": "poplabels",
        "type": "symbol",
        "source": "popData",
        "layout": {
            "visibility": "none",
            "text-field": "{name}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-size": 10,
            "text-offset": [0, 1 ],
            "text-anchor": "top"
        },
        "paint": {
            "text-color": "#555"
        }
    });

    // var colorStops = [

    //                 ["Newfoundland and Labrador", "#3182BD"],
    //                 ["Prince Edward Island", "#3182BD"],
    //                 ["Nova Scotia", "#3182BD"],
    //                 ["New Brunswick", "#3182BD"],

    //                 ["British Columbia", "#31A354"],

    //                 ["Manitoba", "#FDAE6B"],
    //                 ["Saskatchewan", "#FDAE6B"],

    //                 ["Alberta", "#E7BA52"],

    //                 ["Ontario", "#756BB1"],

    //                 ["Quebec", "#17BECF"],

    //                 ["Yukon", "#E377C2"],
    //                 ["Northwest Territories", "#E377C2"],
    //                 ["Nunavut", "#E377C2"]
                    
    //             ];

    function calcCount(p) {
        var scaleFactor = 0.05;
        var area = p * scaleFactor;
          return Math.sqrt(area/Math.PI)*2;
    }

    function stylePop() {
        return {
            "circle-radius": {
                    property: 'pop_2016',
                    base: 2,
                    type: 'interval',
                    stops: [
                        [10000, 4],
                        [50000, 6],
                        [100000, 8],
                        [500000, 10],
                        [1000000, 12],
                    ]
                },
            "circle-opacity": 0.85,
            "circle-stroke-color": "#FFFFFF",
            "circle-stroke-width": 0.2,
            "circle-color": {
                property: 'pr',
                type: "categorical",
                stops: [

                    ["Newfoundland and Labrador", "#3182BD"],
                    ["Prince Edward Island", "#3182BD"],
                    ["Nova Scotia", "#3182BD"],
                    ["New Brunswick", "#3182BD"],

                    ["British Columbia", "#31A354"],

                    ["Manitoba", "#FDAE6B"],
                    ["Saskatchewan", "#FDAE6B"],

                    ["Alberta", "#FF3030"],

                    ["Ontario", "#756BB1"],

                    ["Quebec", "#17BECF"],

                    ["Yukon", "#E377C2"],
                    ["Northwest Territories", "#E377C2"],
                    ["Nunavut", "#E377C2"]
                    
                ]
                
            }
        }
    }

    function styleLine() {
        return {
            "line-width": 1.5,
            "line-blur":1,
            "line-color": {
                property: 'pr',
                type: "categorical",
                stops: [

                    ["Newfoundland and Labrador", "#3182BD"],
                    ["Prince Edward Island", "#3182BD"],
                    ["Nova Scotia", "#3182BD"],
                    ["New Brunswick", "#3182BD"],

                    ["British Columbia", "#31A354"],

                    ["Manitoba", "#FDAE6B"],
                    ["Saskatchewan", "#FDAE6B"],

                    ["Alberta", "#FF3030"],

                    ["Ontario", "#756BB1"],

                    ["Quebec", "#17BECF"],

                    ["Yukon", "#E377C2"],
                    ["Northwest Territories", "#E377C2"]
                    
                ]
                
            }
        }
    }

    function styleLine3D() {
          return {
            'fill-extrusion-color': {
                property: 'pr',
                type: "categorical",
                stops: [

                    ["Newfoundland and Labrador", "#3182BD"],
                    ["Prince Edward Island", "#3182BD"],
                    ["Nova Scotia", "#3182BD"],
                    ["New Brunswick", "#3182BD"],

                    ["British Columbia", "#31A354"],

                    ["Manitoba", "#FDAE6B"],
                    ["Saskatchewan", "#FDAE6B"],

                    ["Alberta", "#FF3030"],

                    ["Ontario", "#756BB1"],

                    ["Quebec", "#17BECF"],

                    ["Yukon", "#E377C2"],
                    ["Northwest Territories", "#E377C2"]
                    
                ]
                
            },
            'fill-extrusion-height': {
                'property': 'whole_chg',
                'type': 'identity'
            },
            'fill-extrusion-opacity': 0.5
        }
      }

});

var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
});


map.on('mousemove', function(e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['poppoints'] });
    var feature = features[0];

    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

        // if the features have no info, return nothing
    if (!features.length) {
        popup.remove();
        return;
    }

    // Populate the popup and set its coordinates
    // based on the feature found
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function getColor(p) {
      return p === "Ontario" ? '#756BB1' :
             p === "Quebec" ? '#17BECF' :
             p === "Alberta" ? '#FF3030' :
             p === "British Columbia" ? '#31A354' :
             p === "Maritimes" ? '#3182BD' :
             p === "Territories" ? '#E377C2' :
             p === "Prairies" ? '#FDAE6B' :
             '#FFF';
    }

    popup.setLngLat(feature.geometry.coordinates)
        .setHTML('<div id="popup" class="popup" style="z-index: 10;">' +
            '<div id="place">' + feature.properties['name'] + ",</div>" +
            '<div id="place">' + feature.properties['pr'] + "</div>" +
            '<h3>Percent Change</h3>' +
            '<div id="mainpoint" style="color:' + getColor(feature.properties['area']) + '">' + feature.properties['pop_chg'] + '%' + " </div>" +
            '<div id="number"> 2016:<b> ' + numberWithCommas(feature.properties['pop_2016']) + " </b></div>" +
            '<div id="number"> 2011:<b> ' + numberWithCommas(feature.properties['pop_2011']) + " </b></div>" + '</div>')
        .addTo(map);
});

map.on('click', function(e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['poppoints'] });
    
    if (features.length) {
        map.setLayoutProperty('poplabels', 'visibility', 'visible');
        map.flyTo({
            center: features[0].geometry.coordinates,
            zoom:9
        });
    } else {
        map.setLayoutProperty('poplabels', 'visibility', 'none');
        map.fitBounds(bounds, {
            padding: 30
        });
    }
});

$('.prtoggles div').click(function() {

      var width = document.documentElement.clientWidth;


      $('.prtoggles div').removeClass('active');
      $(this).addClass('active');
      var data = $(this).attr('data-id');

      if (data === 'all') {
        $('#desc').html('Percentage change in population (2011-2016)');
        map.fitBounds(bounds, {
            padding: 30
        });
        map.setLayoutProperty('poplines3D', 'visibility', 'none');
        map.setLayoutProperty('poplabels', 'visibility', 'none');
        map.setPaintProperty('poppoints', 'circle-opacity', 0.85);
        map.setFilter('poplines', ["has", 'area']);
        map.setFilter('poppoints', ["has", 'area']);
        map.setFilter('poplabels', ["has", 'area']);
        map.flyTo({
            bearing: 0,
            pitch: 0,
            speed: 0.1
        });
      } else {
        map.fitBounds(bounds, {
            padding: 60
        });
        $('#desc').html('Heights represent actual population change (2011-2016)');
        map.setLayoutProperty('poplines3D', 'visibility', 'visible');
        map.setLayoutProperty('poplabels', 'visibility', 'visible');
        map.setPaintProperty('poppoints', 'circle-opacity', 0.2);
        map.setFilter('poplines3D', ["==", 'area', data]);
        map.setFilter('poppoints', ["==", 'area', data]);
        map.setFilter('poplines', ["==", 'area', data]);
        map.setFilter('poplabels', ["==", 'area', data]);
        map.flyTo({
            bearing: -45,
            pitch: 60,
            speed: 0.1
        });
      }
      return false

      function getZoom(width) {
            if (width > 550) {
                return 7;
            }  else {
                return 6;
            }
        };
    });

</script>

</body>
</html>
